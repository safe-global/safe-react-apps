name: Safe Apps E2E
on:
  pull_request:
  push:
    # branches:
    #   - development
    #   - main      

jobs:
  serve-web-core:
    runs-on: ubuntu-latest
    name: Serve web-core
    env:
      NEXT_PUBLIC_INFURA_TOKEN: ${{ secrets.NEXT_PUBLIC_INFURA_TOKEN }}
      NEXT_PUBLIC_SAFE_APPS_INFURA_TOKEN: ${{ secrets.NEXT_PUBLIC_SAFE_APPS_INFURA_TOKEN }}
      NEXT_PUBLIC_TENDERLY_ORG_NAME: ${{ secrets.NEXT_PUBLIC_TENDERLY_ORG_NAME }}
      NEXT_PUBLIC_TENDERLY_PROJECT_NAME: ${{ secrets.NEXT_PUBLIC_TENDERLY_PROJECT_NAME }}
      NEXT_PUBLIC_TENDERLY_SIMULATE_ENDPOINT_URL: ${{ secrets.NEXT_PUBLIC_TENDERLY_SIMULATE_ENDPOINT_URL }}
      NEXT_PUBLIC_CYPRESS_MNEMONIC: ${{ secrets.NEXT_PUBLIC_CYPRESS_MNEMONIC }}
    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ github.token }}

      - uses: actions/checkout@v3
        with:
          repository: safe-global/web-core

      - name: Yarn cache
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: web-core-modules-${{ hashFiles('**/yarn.lock') }}

      - name: Yarn install
        run: |
          yarn install

      - name: Yarn start
        run: |
          yarn start

  serve-safe-apps:
    runs-on: ubuntu-latest
    name: Serve Safe Apps
    env:
      REACT_APP_WALLETCONNECT_PROJECT_ID:
      REACT_APP_RPC_TOKEN:
      REACT_APP_TENDERLY_SIMULATE_ENDPOINT_URL:
      REACT_APP_TENDERLY_PROJECT_NAME:
      REACT_APP_TENDERLY_ORG_NAME:
    steps:
      - name: Checkout safe-react-apps
        uses: actions/checkout@v2

      - name: Set PR Safe Apps base URL
        run: |
          echo "SAFE_APPS_BASE_URL=https://pr${{ github.event.number }}--safereactapps.review-react-hr.5afe.dev" >> $GITHUB_ENV
          echo "BASE_URL=https://safe-web.dev.5afe.dev/app" >> $GITHUB_ENV
        if: github.ref != 'refs/heads/development'
      - name: Set development Safe Apps base URL
        run: |
          echo "SAFE_APPS_BASE_URL=https://safe-apps.dev.5afe.dev" >> $GITHUB_ENV
          echo "BASE_URL=https://safe-web.dev.5afe.dev/app" >> $GITHUB_ENV
        if: github.ref == 'refs/heads/development'
      - name: Set main Safe Apps base URL
        run: |
          echo "SAFE_APPS_BASE_URL=https://apps.gnosis-safe.io" >> $GITHUB_ENV
          echo "BASE_URL=https://gnosis-safe.io/app" >> $GITHUB_ENV
        if: ${{ github.ref == 'refs/heads/main' || github.event.schedule == '0 9 * * 1-5' }}

      - name: Yarn install
        run: |
          yarn install --immutable
          ./node_modules/.bin/cypress install

      - name: Build
        run: yarn build

      - name: Start
        run: yarn start:tx-builder & yarn start:drain-safe

  serve-safe-apps:
      - uses: cypress-io/github-action@v2
        with:
          browser: chrome
          record: true
          spec: cypress/integration/drain-account/drain.spec.js,cypress/integration/tx-builder/tx-builder.spec.js
        env:
          CI: 'true'
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          CYPRESS_WEB_BASE_URL: ${{env.BASE_URL}}
          CYPRESS_SAFE_APPS_BASE_URL: ${{env.SAFE_APPS_BASE_URL}}
          CYPRESS_CHAIN_ID: '4'
          CYPRESS_NETWORK_PREFIX: 'rin'
          CYPRESS_TESTING_SAFE_ADDRESS: '0x3bc83f41490BfD25bBB44eBCAc3761DFF4Ae50DA'
          CYPRESS_CLIENT_GATEWAY_BASE_URL: 'https://safe-client.safe.global'
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
